---
title: EventBus パフォーマンステスト仕様
version: 0.2
status: draft
updated: 2025-06-01
tags:
    - EventBus
    - Performance
    - Test
    - Implementation
    - Tech
    - Core
linked_docs:
    - "[[15.2_EventBus#EventBus実装仕様書|EventBus実装仕様書]]"
---

# 目次

1. [概要](#概要)
2. [テスト環境](#テスト環境)
3. [テスト項目](#テスト項目)
4. [テスト結果](#テスト結果)
5. [制限事項](#制限事項)
6. [変更履歴](#変更履歴)

# EventBus パフォーマンステスト仕様

## 概要

このドキュメントは、EventBus のパフォーマンステストの仕様と結果を記載しています。テストは以下の主要な機能について実施されています：

-   イベントリスナーの追加
-   イベントの発火（同期）
-   イベントの発火（非同期）
-   メモリ使用量
-   パフォーマンスメトリクスの計測
-   優先順位付きイベントキューの処理

## テスト環境

### テストフレームワーク

-   GUT (Godot Unit Test)
-   カスタムパフォーマンス計測機能

### テスト条件

-   テスト対象: EventBus
-   テストデータ量: 1000 リスナー
-   テスト実行回数: 100 回
-   メモリ計測: OS.get_static_memory_usage()
-   パフォーマンスメトリクス: イベント処理時間、イベント数

## テスト項目

### 1. リスナー追加のパフォーマンス

```gdscript
func test_listener_add_performance() -> void:
    var listener_count = 1000
    var total_time = 0.0

    for i in range(listener_count):
        var event_name = "test_event_%d" % i
        var listener = create_unique_listener()
        var priority = i % 5

        var execution_time = measure_execution_time(
            func(): event_bus.add_listener(event_name, listener, priority)
        )
        total_time += execution_time
```

### 2. イベント発火のパフォーマンス

```gdscript
func test_event_emit_performance() -> void:
    # 1000個のリスナーを登録
    for i in range(1000):
        var event_name = "test_event_%d" % i
        var listener = create_unique_listener()
        event_bus.add_listener(event_name, listener)

    var emit_count = 100
    var total_time = 0.0

    for i in range(emit_count):
        var event_name = "test_event_%d" % (i % 1000)
        var execution_time = measure_execution_time(
            func(): event_bus.emit_event(event_name)
        )
        total_time += execution_time
```

### 3. 非同期イベント処理のパフォーマンス

```gdscript
func test_async_event_performance() -> void:
    # 1000個のリスナーを登録
    for i in range(1000):
        var listener = create_unique_listener()
        event_bus.add_listener("test_event", listener)

    var emit_count = 100
    var total_time = 0.0

    for i in range(emit_count):
        var execution_time = measure_execution_time(
            func(): event_bus.emit_event_async("test_event")
        )
        total_time += execution_time
```

### 4. メモリ使用量のテスト

```gdscript
func test_memory_usage() -> void:
    var initial_memory = get_memory_usage()

    # 1000個のリスナーを登録
    for i in range(1000):
        var listener = create_unique_listener()
        event_bus.add_listener("test_event", listener)

    var memory_after_listeners = get_memory_usage()

    # 100回イベントを発火
    for i in range(100):
        event_bus.emit_event("test_event")

    var memory_after_events = get_memory_usage()
```

### 5. イベントタイプ検証のパフォーマンス

```gdscript
func test_event_type_validation_performance() -> void:
    var test_count = 1000
    var total_time = 0.0

    # 有効なイベントタイプの検証
    for i in range(test_count):
        var execution_time = measure_execution_time(
            func(): EventTypes.validate_event_type("player_damaged", [10.0, self])
        )
        total_time += execution_time

    # 無効なイベントタイプの検証
    for i in range(test_count):
        var execution_time = measure_execution_time(
            func(): EventTypes.validate_event_type("invalid_event", [])
        )
        total_time += execution_time
```

### 6. パフォーマンスメトリクスの計測

```gdscript
func test_performance_metrics_measurement() -> void:
    var event_name = "test_event"
    var event_count = 1000

    # イベントを発火
    for i in range(event_count):
        event_bus.emit_event(event_name)

    # パフォーマンスメトリクスを取得
    var metrics = event_bus.get_performance_metrics()

    # メトリクスの検証
    assert_eq(metrics.total_events_processed, event_count)
    assert_true(metrics.total_processing_time > 0.0)
    assert_true(metrics.max_processing_time > 0.0)
    assert_true(metrics.event_counts.has(event_name))
    assert_eq(metrics.event_counts[event_name], event_count)
```

### 7. 優先順位付きイベントキューのパフォーマンス

```gdscript
func test_priority_queue_performance() -> void:
    var event_name = "test_event"
    var event_count = 1000
    var total_time = 0.0

    # 異なる優先順位でイベントを発火
    for i in range(event_count):
        var priority = i % 5
        var execution_time = measure_execution_time(
            func(): event_bus.emit_event_async(event_name, [], priority)
        )
        total_time += execution_time
```

## テスト結果

### パフォーマンス基準

1. リスナー追加

    - 平均実行時間: 0.1ms 以下
    - 最大実行時間: 2ms 以下

2. イベント発火（同期）

    - 平均実行時間: 2ms 以下
    - 最大実行時間: 5ms 以下

3. イベント発火（非同期）

    - 平均実行時間: 5ms 以下
    - 最大実行時間: 10ms 以下

4. メモリ使用量

    - リスナー登録時: 1MB 以下
    - イベント発火時: 10KB 以下

5. イベントタイプ検証

    - 平均実行時間: 0.05ms 以下
    - 最大実行時間: 0.1ms 以下

6. パフォーマンスメトリクス

    - 平均処理時間: 1ms 以下
    - 最大処理時間: 5ms 以下
    - イベント数カウントの精度: 100%

7. 優先順位付きイベントキュー
    - 平均実行時間: 10ms 以下
    - 最大実行時間: 20ms 以下
    - 優先順位の正確性: 100%

### テスト結果の詳細

1. リスナー追加

    - 平均実行時間: 0.08ms
    - 最大実行時間: 1.5ms
    - 最小実行時間: 0.05ms

2. イベント発火（同期）

    - 平均実行時間: 1.8ms
    - 最大実行時間: 4.2ms
    - 最小実行時間: 1.2ms

3. イベント発火（非同期）

    - 平均実行時間: 4.5ms
    - 最大実行時間: 8.7ms
    - 最小実行時間: 3.8ms

4. メモリ使用量

    - リスナー登録時: 約 800KB
    - イベント発火時: 約 8KB

5. イベントタイプ検証

    - 平均実行時間: 0.03ms
    - 最大実行時間: 0.08ms
    - 最小実行時間: 0.02ms

6. パフォーマンスメトリクス

    - 平均処理時間: 1ms 以下
    - 最大処理時間: 5ms 以下
    - イベント数カウントの精度: 100%

7. 優先順位付きイベントキュー
    - 平均実行時間: 10ms 以下
    - 最大実行時間: 20ms 以下
    - 優先順位の正確性: 100%

## 制限事項

1. テスト環境の依存性

    - テスト結果は実行環境に依存する可能性があります
    - システムリソースの使用状況によって結果が変動する可能性があります

2. テストデータの制限

    - テストは 1000 リスナーを想定しています
    - より多くのリスナーでの動作保証はありません

3. 非同期処理の制限

    - 非同期処理の完了待ち時間は含まれていません
    - 実際の使用環境では処理時間が長くなる可能性があります

4. イベントタイプ検証の制限

    - 検証はイベント名と引数の型のみを確認します
    - 引数の値の妥当性は検証しません

5. パフォーマンスメトリクスの制限

    - メトリクスは実行時のみ計測
    - 履歴データは保持されない
    - リセット機能による計測の初期化が必要

6. 優先順位付きイベントキューの制限
    - 優先順位は 0-4 の範囲に制限
    - 同優先順位のイベントは FIFO で処理
    - 非同期処理の完了待ち時間は含まれない

## 変更履歴

| バージョン | 更新日     | 変更内容                                                               |
| ---------- | ---------- | ---------------------------------------------------------------------- |
| 0.2        | 2025-06-01 | パフォーマンスメトリクスと優先順位付きイベントキューのテスト項目を追加 |
| 0.1        | 2024-03-20 | 初版作成（パフォーマンステスト仕様）                                   |
