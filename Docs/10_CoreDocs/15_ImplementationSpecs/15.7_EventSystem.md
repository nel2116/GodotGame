---
title: イベントシステム実装仕様
version: 0.1
status: draft
updated: 2024-03-20
tags:
    - EventSystem
    - EventTypes
    - System
    - Implementation
    - Tech
    - Core
linked_docs:
    - "[[15.1_GameSystems#GameSystems実装仕様書|GameSystems実装仕様書]]"
    - "[[15.2_EventBus#EventBus実装仕様書|EventBus実装仕様書]]"
    - "[[15.3_EventBusPerformance#EventBusパフォーマンス仕様書|EventBusパフォーマンス仕様書]]"
    - "[[14_DetailedDesign#詳細設計書|詳細設計書]]"
    - "[[14.2_ClassDiagram#クラス図|クラス図]]"
    - "[[14.4_SequenceDiagram#シーケンス図|シーケンス図]]"
---

# 目次

1. [概要](#概要)
2. [主要コンポーネント](#主要コンポーネント)
    - [EventBus](#eventbus)
    - [EventTypes](#eventtypes)
3. [イベントカテゴリ](#イベントカテゴリ)
4. [定義済みイベント](#定義済みイベント)
5. [型安全性](#型安全性)
6. [デバッグ](#デバッグ)
7. [テスト](#テスト)
8. [注意事項](#注意事項)
9. [変更履歴](#変更履歴)

# イベントシステム

## 概要

イベントシステムは、ゲーム内の様々なイベントを管理し、型安全な方法でイベントの発火と受信を行うためのシステムです。

## 主要コンポーネント

### EventBus

イベントの発火と受信を管理するメインクラスです。

#### 主な機能

-   イベントリスナーの登録/解除
-   同期/非同期イベントの発火
-   優先順位付きのイベント処理
-   デバッグモード

#### 使用例

```gdscript
# リスナーの登録
event_bus.add_listener("player_damaged", _on_player_damaged)

# イベントの発火
event_bus.emit_event("player_damaged", [10.0, damage_source])

# 非同期イベントの発火
event_bus.emit_event_async("game_ended", [100, "victory"])
```

### EventTypes

イベントタイプを定義し、型安全性を確保するクラスです。

#### イベントタイプのアクセス方法

イベントタイプは以下の方法でアクセスできます：

```gdscript
# イベントタイプの取得
var event_type = EventTypes.get_event_type("player_damaged")

# イベントタイプの検証
var is_valid = EventTypes.validate_event_type("player_damaged", [10.0, damage_source])

# すべてのイベントタイプの取得
var all_types = EventTypes.get_all_event_types()
```

#### イベントカテゴリ

-   GAME_STATE: ゲーム状態関連
-   PLAYER: プレイヤー関連
-   ENEMY: 敵関連
-   ROOM: 部屋関連
-   UI: UI 関連
-   SYSTEM: システム関連

#### 定義済みイベント

##### ゲーム状態関連

-   `game_started`: ゲーム開始
-   `game_paused`: ゲーム一時停止
-   `game_resumed`: ゲーム再開
-   `game_ended`: ゲーム終了
    -   パラメータ:
        -   `score`: int - 最終スコア
        -   `reason`: String - 終了理由

##### プレイヤー関連

-   `player_damaged`: プレイヤーダメージ
    -   パラメータ:
        -   `amount`: float - ダメージ量
        -   `source`: Node - ダメージ源
-   `player_healed`: プレイヤー回復
    -   パラメータ:
        -   `amount`: float - 回復量
        -   `source`: Node - 回復源
-   `player_died`: プレイヤー死亡
    -   パラメータ:
        -   `killer`: Node - キラー

##### 敵関連

-   `enemy_damaged`: 敵ダメージ
    -   パラメータ:
        -   `enemy`: Node - 敵オブジェクト
        -   `amount`: float - ダメージ量
        -   `source`: Node - ダメージ源
-   `enemy_died`: 敵死亡
    -   パラメータ:
        -   `enemy`: Node - 敵オブジェクト
        -   `killer`: Node - キラー

##### 部屋関連

-   `room_entered`: 部屋進入
    -   パラメータ:
        -   `room_id`: String - 部屋 ID
        -   `player`: Node - プレイヤーオブジェクト
-   `room_cleared`: 部屋クリア
    -   パラメータ:
        -   `room_id`: String - 部屋 ID
        -   `clear_time`: float - クリア時間

## 型安全性

イベントシステムは以下の方法で型安全性を確保しています：

1. イベント名の検証
2. パラメータ数の検証
3. パラメータ型の検証

## デバッグ

イベントシステムのデバッグは以下の方法で行えます：

1. EventBus のデバッグモード有効化
2. イベントの検証ログの出力
3. リスナーの登録/解除の追跡

## テスト

イベントシステムのテストは以下の項目をカバーしています：

1. イベントタイプの検証
2. イベントパラメータの検証
3. イベントリスナーの登録/解除
4. イベントの発火（同期/非同期）

## 注意事項

1. イベント名は文字列で指定する必要があります
2. パラメータの型と順序は厳密に守る必要があります
3. 非同期イベントは順序が保証されません

## 変更履歴

-   2024-03-20: イベントタイプのアクセス方法を変更（定数から辞書ベースに）
-   2024-03-19: 初版作成
