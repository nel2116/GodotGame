---
title: MVVM+RX基本設計書
version: 0.2.0
status: draft
updated: 2024-03-23
tags:
    - Core
    - Design
    - MVVM
    - Reactive
linked_docs:
    - "[[12_01_mvvm_rx_architecture|MVVM+RXアーキテクチャ]]"
    - "[[12_03_detailed_design|MVVM+RX詳細設計書]]"
    - "[[12_04_system_integration|システム間連携]]"
    - "[[12_05_common_utilities|共通ユーティリティ]]"
---

# MVVM+RX 基本設計書

## 目次

1. [概要](#1-概要)
2. [基本設計](#2-基本設計)
3. [コンポーネント設計](#3-コンポーネント設計)
4. [インターフェース設計](#4-インターフェース設計)
5. [データフロー](#5-データフロー)
6. [エラー処理](#6-エラー処理)
7. [ベストプラクティス](#7-ベストプラクティス)
8. [制限事項](#8-制限事項)
9. [変更履歴](#9-変更履歴)

## 1. 概要

### 1.1 目的

本ドキュメントは、Shrine of the Lost Ones における MVVM + リアクティブプログラミングの基本設計を定義し、以下の目的を達成することを目指します：

-   アーキテクチャの具体的な実装方針の確立
-   開発チーム間での実装の一貫性確保
-   保守性と拡張性の高いコードベースの構築

### 1.2 適用範囲

-   ゲームコアシステム
-   UI/UX システム
-   データ管理システム
-   イベントシステム

## 2. 基本設計

### 2.1 レイヤー構造

#### 2.1.1 レイヤー構成

```
[View Layer (Godot Node)]
    ↓
[ViewModel Layer (ReactiveProperty)]
    ↓
[Model Layer (Business Logic)]
    ↓
[Service Layer (External Resources)]
```

#### 2.1.2 各レイヤーの責務

| レイヤー  | 責務               | 実装例               |
| --------- | ------------------ | -------------------- |
| View      | UI 表示・入力受付  | Godot Node           |
| ViewModel | 状態管理・変換     | ReactiveProperty     |
| Model     | ビジネスロジック   | ゲームロジッククラス |
| Service   | 外部連携・共通機能 | リソース管理         |

### 2.2 データフロー

#### 2.2.1 一方向データフロー

```
[User Input] → [View] → [ViewModel] → [Model] → [Service]
```

#### 2.2.2 双方向バインディング

-   フォーム入力などの特定のケースでのみ使用
-   基本的には一方向データフローを推奨

## 3. コンポーネント設計

### 3.1 基本コンポーネント

#### 3.1.1 View

-   Godot の Node を継承
-   UI の表示とユーザー入力の処理
-   ViewModel とのバインディング
-   アニメーションやエフェクトの制御

#### 3.1.2 ViewModel

-   ReactiveProperty を継承
-   状態管理とデータ変換
-   コマンドの実装
-   バリデーションロジック

#### 3.1.3 Model

-   ビジネスロジックの実装
-   データの永続化
-   ドメインルールの適用
-   状態の保持

### 3.2 共通コンポーネント

#### 3.2.1 コマンド

-   ICommand インターフェースの実装
-   実行可能状態の管理
-   非同期処理のサポート
-   エラーハンドリング

#### 3.2.2 バリデーター

-   入力値の検証
-   エラーメッセージの管理
-   カスタムバリデーションルール
-   非同期バリデーション

## 4. インターフェース設計

### 4.1 基本インターフェース

#### 4.1.1 IViewModel

```gdscript
interface IViewModel:
    func initialize()
    func dispose()
    func update()
```

#### 4.1.2 IModel

```gdscript
interface IModel:
    func load()
    func save()
    func validate()
```

### 4.2 サービスインターフェース

#### 4.2.1 IDataService

```gdscript
interface IDataService:
    func get_data(key: String) -> Dictionary
    func set_data(key: String, value: Dictionary)
    func delete_data(key: String)
```

#### 4.2.2 IEventService

```gdscript
interface IEventService:
    func subscribe(event_name: String, callback: Callable)
    func publish(event_name: String, data: Dictionary)
    func unsubscribe(event_name: String, callback: Callable)
```

## 5. データフロー

### 5.1 基本的なデータフロー

#### 5.1.1 一方向データフロー

1. ユーザーアクション
2. View のイベント発火
3. ViewModel のコマンド実行
4. Model の状態更新
5. ViewModel の状態更新
6. View の更新

#### 5.1.2 双方向バインディング

-   フォーム入力
-   リアルタイムプレビュー
-   インスタントフィードバック

### 5.2 非同期データフロー

#### 5.2.1 非同期処理

-   コルーチンの使用
-   シグナルの活用
-   エラーハンドリング

#### 5.2.2 キャッシュ戦略

-   メモリキャッシュ
-   ディスクキャッシュ
-   キャッシュの無効化

## 6. エラー処理

### 6.1 エラーハンドリング

#### 6.1.1 例外処理

-   カスタム例外クラス
-   例外の伝播
-   グローバルエラーハンドラー

#### 6.1.2 エラー通知

-   エラーメッセージの表示
-   ログ記録
-   エラーリカバリー

### 6.2 バリデーション

#### 6.2.1 入力バリデーション

-   必須チェック
-   型チェック
-   範囲チェック

#### 6.2.2 ビジネスルール

-   ドメインルールの検証
-   整合性チェック
-   依存関係の検証

## 7. ベストプラクティス

### 7.1 コーディング規約

#### 7.1.1 命名規則

-   クラス名: PascalCase
-   メソッド名: snake_case
-   変数名: snake_case
-   定数: UPPER_SNAKE_CASE

#### 7.1.2 ファイル構成

-   1 ファイル 1 クラス
-   関連ファイルのグループ化
-   適切なディレクトリ構造

### 7.2 パフォーマンス最適化

#### 7.2.1 メモリ管理

-   適切なリソース解放
-   オブジェクトプーリング
-   メモリリークの防止

#### 7.2.2 実行効率

-   不要な更新の防止
-   バッチ処理の活用
-   キャッシュの最適化

## 8. 制限事項

### 8.1 メモリ管理

-   適切なタイミングで Dispose を呼び出す必要がある
-   循環参照に注意が必要
-   リソースの適切な解放

### 8.2 パフォーマンス

-   重い処理は非同期で実行する
-   更新頻度の最適化
-   リソース使用量の制御

### 8.3 スレッドセーフ

-   マルチスレッド環境での使用には注意が必要
-   適切な同期処理を実装する
-   UI スレッドとの連携に注意

## 9. 変更履歴

| バージョン | 更新日     | 変更内容                                                                                       |
| ---------- | ---------- | ---------------------------------------------------------------------------------------------- |
| 0.2.0      | 2024-03-23 | 機能拡張<br>- コンポーネント設計の追加<br>- インターフェース設計の追加<br>- データフローの追加 |
| 0.1.0      | 2024-03-21 | 初版作成<br>- 基本設計の追加<br>- エラー処理の定義<br>- ベストプラクティスの追加               |
